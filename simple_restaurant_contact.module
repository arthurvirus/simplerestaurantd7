<?php

/**
 * @defgroup simple_restaurant_contact 
 */

 
 // --------------------------------------------
 // ----------------- BLOCKS -------------------
 // --------------------------------------------


/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function simple_restaurant_contact_block_info() {

  $blocks['restaurant_contact'] = array(
    // info: The name of the block.
    'info' => t('Restaurant Contact'),
    // Block caching options (per role, per user, etc.)
    'cache' => DRUPAL_CACHE_PER_ROLE, // default
	'status' => TRUE,
    'region' => 'sidebar_first',  // Not usually provided. // TODO change according to theme
    'visibility' => BLOCK_VISIBILITY_LISTED,  // Not usually provided.
    'pages' => '<front>', // Not usually provided here.
  );
  
   $blocks['restaurant_opening_hours'] = array(
    // info: The name of the block.
    'info' => t('Restaurant Opening Hours'),
    // Block caching options (per role, per user, etc.)
    'cache' => DRUPAL_CACHE_PER_ROLE, // default
	'status' => TRUE,
    'region' => 'sidebar_first',  // Not usually provided. // TODO change according to theme
    'visibility' => BLOCK_VISIBILITY_LISTED,  // Not usually provided.
    'pages' => '<front>', // Not usually provided here.
  );
  
  return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function simple_restaurant_contact_block_view($delta = '') {
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'restaurant_contact':
      $block['subject'] = t('Contact');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = contact_contents('block');
      break;
	case 'restaurant_opening_hours':
      $block['subject'] = t('Opening Hours');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = opening_hours_contents();
      break;
  }
  return $block;
}



 // --------------------------------------------
 // --------------- MENU - PAGES ---------------
 // --------------------------------------------
 
/**
 * Implements hook_menu().
 * 
 * Create different pages for the modules
 */
function simple_restaurant_contact_menu() {

$items = array();
// Up Menu for admin module by owner
$items['admin/simple_restaurant'] = array(
    'title' => t('Simple Restaurant'),
    'access arguments' => array('access content'),
	'description'	   => t('Admin pages for Simple Restaurant Module'),
	'type'             => MENU_NORMAL_ITEM,
	'menu_name'        => 'Management',
  );
  
  
  $items['admin/simple_restaurant/information_admin'] = array(
    'title' => t('Contact Information Admin'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('information_form'),
    'access callback' => TRUE,
	'description'	   => t('Edit information about the restaurant (Opening hours, Telephone number,..)'),
	'type'             => MENU_NORMAL_ITEM,
	'menu_name'        => 'Management',
  );
  
  $items['information'] = array(
    'title' => t('General information'),
    'page callback' => 'information_page',
    'access arguments' => array('access content'),
    'type'             => MENU_NORMAL_ITEM,
	'menu_name'        => 'main-menu',
  );

  return $items;
}



/**
 * Edit information page
 *  
 */
function information_page(){

  $items = array();
  drupal_add_css(drupal_get_path('module', 'simple_restaurant_contact') . '/simple_restaurant-views.css');

  $items['opening_hours_title']['#markup']  = '<h2>'.t('Contact').'</h2>';
  $items['opening_hours'] = contact_contents('page') ;
  
  $items['contact_title']['#markup']  = '<h2>'.t('Opening Hours').'</h2>';
  $items['contact'] = opening_hours_contents() ;
  
  return $items;
}


/**
 * Return render table with contact information
 */
function contact_contents($type) {
  $content  ='';
  $gmap = '';

  drupal_add_css(drupal_get_path('module', 'simple_restaurant_contact') . '/simple_restaurant-views.css');
  
  if ($type != 'block'){
  
    $gmap = variable_get('simple_restaurant_contact_gmap');
    //TODO better map handling ?
    //$gmap = '<iframe width="300" height="300" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.be/maps?f=q&amp;source=s_q&amp;hl=fr&amp;geocode=&amp;q=Avenue+Reine+Astrid+9,+Namur,+Belgique&amp;aq=0&amp;oq=avenue+reine+astrid+9,++Namur,+belgique&amp;sll=50.461646,4.856787&amp;sspn=0.01101,0.027874&amp;ie=UTF8&amp;hq=&amp;t=m&amp;spn=0.016392,0.025749&amp;z=14&amp;iwloc=A&amp;output=embed"></iframe><br /><small><a href="https://maps.google.be/maps?f=q&amp;source=embed&amp;hl=fr&amp;geocode=&amp;q=Avenue+Reine+Astrid+9,+Namur,+Belgique&amp;aq=0&amp;oq=avenue+reine+astrid+9,++Namur,+belgique&amp;sll=50.461646,4.856787&amp;sspn=0.01101,0.027874&amp;ie=UTF8&amp;hq=&amp;hnear=Avenue+Reine+Astrid+9,+Namur+5000+Namur,+R%C3%A9gion+wallonne&amp;t=m&amp;ll=50.461657,4.856815&amp;spn=0.016392,0.025749&amp;z=14&amp;iwloc=A" style="color:#0000FF;text-align:left">Agrandir le plan</a></small>' ;
  }
  
  //TODO meilleure mise en page
  $content .= '<br>';
  
  //$content .= t('Telephone Number : ') ;
  $content .= variable_get('simple_restaurant_contact_telephone');
  if ( strlen(variable_get('simple_restaurant_contact_telephone')) > 0 ){ $content .= '<br>'; }
  
  //$content .= t('Telephone Number : ') ;
  $content .= variable_get('simple_restaurant_contact_mobile');
  if ( strlen(variable_get('simple_restaurant_contact_mobile')) > 0 ){ $content .= '<br>'; }
  //$content .= t('Email : ') ;
  $content .= variable_get('simple_restaurant_contact_email') ;
  if ( strlen(variable_get('simple_restaurant_contact_email')) > 0 ){ $content .= '<br>'; }
  
  //Replace text area line break by html ones
  $address =  strtr( variable_get('simple_restaurant_contact_address'), array("\r\n" => '<br />', "\r" => '<br />', "\n" => '<br />'));
  //$content .= t('Address : ')  ;
  $content .= $address ;
  $content .= '<br>';

  $content .= $gmap;
  return array('#markup' => $content);

}

/**
 * Return render table with opening hours
 */
function opening_hours_contents() {

//todo keep only the needed stuff
	$options = array(
      'type' => 'file',
      'group' => CSS_THEME,
      'weight' => 100,
      'every_page' => FALSE,
      'media' => 'all',
      'preprocess' => TRUE,
      'browsers' => array(),
    );
  drupal_add_css(drupal_get_path('module', 'simple_restaurant_contact') . '/simple_restaurant-views.css', $options);
  
  $opening_hours_type = variable_get('simple_restaurant_contact_opening_hours_type');

  if( $opening_hours_type == 'table'){
  
  
  $header = array( t('Day'), t('Morning') , t('Evening') );
  $rows = variable_get('simple_restaurant_contact_opening_hours');
  //Add custom css class to the opening hours table
  $attributes = array('id' => array('opening_table'));
  
  $opening_hours = "<br>". theme('table', array('header' => $header, 'rows' => $rows, 'attributes' => $attributes));
  
  $content = $opening_hours;
  }
  else
  {
	$content = variable_get('simple_restaurant_contact_opening_hours_text');
  }
  
  
  return array('#markup' => $content);
}

//-------------------------------------
//------------- FORMS
//-------------------------------------


/**
 * Edit information form 
 *
 */
function information_form($form, &$form_state){

  $form['contact'] = array(
    '#type' => 'fieldset',
    '#title' => t('Contact'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['contact']['telephone'] = array(
    '#type' => 'textfield',
    '#title' => t('Telephone Number'),
	'#default_value' => variable_get('simple_restaurant_contact_telephone'),
  );
  
   $form['contact']['mobile'] = array(
    '#type' => 'textfield',
    '#title' => t('Mobile phone Number'),
	'#default_value' => variable_get('simple_restaurant_contact_mobile'),
  );
  
    $form['contact']['email'] = array(
    '#type' => 'textfield',
    '#title' => t('Email'),
	'#default_value' => variable_get('simple_restaurant_contact_email'),
  );  

  $form['contact']['address'] = array(
    '#type' => 'textarea',
    '#title' => t('Address'),
	'#default_value' => variable_get('simple_restaurant_contact_address'),
  );
  
  $form['contact']['gmap'] = array(
    '#type' => 'textarea',
    '#title' => t('Google Map'),
	'#description' => t('Insert link from Google Map'),
	'#default_value' => variable_get('simple_restaurant_contact_gmap'),
  );
  

  $form['opening'] = array(
    '#type' => 'fieldset',
    '#title' => t('Opening hours'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );
  
  $form['opening']['opening_type'] = array(
    '#type' => 'radios',
	'#default_value' => variable_get('simple_restaurant_contact_opening_hours_type'),
    '#options' => array(
      'free_text'   => t('Free text'),
      'table' => t('Full table with days'),
    ),
    '#title' => t('What type of display do you want ?')
  );
  
  $form['opening']['free_text'] = array(
    '#type' => 'textarea',
    '#title' => t('Opening Hours'),
    // This #states rule says that the "high school" fieldset should only
    // be shown if the "student_type" form element is set to "High School".
	'#default_value' => variable_get('simple_restaurant_contact_opening_hours_text',''),
    '#states' => array(
      'visible' => array(
        ':input[name="opening_type"]' => array('value' => 'free_text'),
      ),
    ),
  );
  
  
  $opening_table_default = array(
    'sun' => array ( 'title' => t('Sunday'), 'am' => '' , 'pm' => '' ),  
	'mon' => array ( 'title' => t('Monday'),'am' => '' , 'pm' => '' ), 
	'tue' => array ( 'title' => t('Tuesday'),'am' => '' , 'pm' => '' ), 
	'wed' => array ( 'title' => t('Wednesday'),'am' => '' , 'pm' => '' ), 
	'thu' => array ( 'title' => t('Thursday'),'am' => '' , 'pm' => '' ), 
	'fri' => array ( 'title' => t('Friday'),'am' => '' , 'pm' => '' ), 
	'sat' => array ( 'title' => t('Saturday'),'am' => '' , 'pm' => '' ), 
	); 
  $opening_hours = variable_get('simple_restaurant_contact_opening_hours', $opening_table_default);
  
  
  $form['opening']['table'] = array(
    '#type' => 'fieldset',
    '#title' => t('Week'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
	'#states' => array(
      'visible' => array(
        ':input[name="opening_type"]' => array('value' => 'table'),
      ),
    ),
  );
  
  
  $form['opening']['table']['opening_sun'] = array(
    //'#prefix' => '<div class="container-inline">',
    //'#suffix' => '</div>',
   //'#type' => 'textfield',
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Sunday'),//.'<br>',	
    //'#default_value' => variable_get('form_example_element_discrete', array('areacode' => '999', 'prefix' => '999', 'extension' => '9999')),
	//'#default_value' => array ( 'am' => variable_get('simple_restaurant_contact_opening_sun_am'), 'pm' => variable_get('simple_restaurant_contact_opening_sun_pm') ),
	'#default_value' => array ( 'am' => $opening_hours['sun']['am'], 'pm' => $opening_hours['sun']['pm'] ),
  );
  
  $form['opening']['table']['opening_mon'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Monday'),
	'#default_value' => array ( 'am' => $opening_hours['mon']['am'], 'pm' => $opening_hours['mon']['pm'] ),
  );
  
    $form['opening']['table']['opening_tue'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Tuesday'),
	'#default_value' => array ( 'am' => $opening_hours['tue']['am'], 'pm' => $opening_hours['tue']['pm'] ),
  );
  
    $form['opening']['table']['opening_wed'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Wednesday'),
	'#default_value' => array ( 'am' => $opening_hours['wed']['am'], 'pm' => $opening_hours['wed']['pm'] ),
  );
  
    $form['opening']['table']['opening_thu'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Thursday'),
	'#default_value' => array ( 'am' => $opening_hours['thu']['am'], 'pm' => $opening_hours['thu']['pm'] ),
  );
  
    $form['opening']['table']['opening_fri'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Friday'),
	'#default_value' => array ( 'am' => $opening_hours['fri']['am'], 'pm' => $opening_hours['fri']['pm'] ),
  );
  
    $form['opening']['table']['opening_sat'] = array(
    '#type' => 'simple_restaurant_contact_opening_day',
    '#title' => t('Saturday'),
	'#default_value' => array ( 'am' => $opening_hours['sat']['am'], 'pm' => $opening_hours['sat']['pm'] ),
  );
  
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save Information'),
  );
  return $form;
}
/**
 * Information form submit
 * 
 */
function information_form_submit($form, &$form_state) {
  /*
  foreach ($form_state['values'] as $key => $value) {
    variable_set($key, $value);
    drupal_set_message(t('%name has value %value', array('%name' => $key, '%value' => print_r($value, TRUE))));
  }*/

  $telephone = $form_state['values']['telephone'];
  variable_set('simple_restaurant_contact_telephone', $telephone);
  
  $mobile = $form_state['values']['mobile'];
  variable_set('simple_restaurant_contact_mobile', $mobile);
  
  $address = $form_state['values']['address'];
  variable_set('simple_restaurant_contact_address', $address);
  
  $gmap = $form_state['values']['gmap'];
  variable_set('simple_restaurant_contact_gmap', $gmap);
  
  $email = $form_state['values']['email'];
  variable_set('simple_restaurant_contact_email', $email);
  
  if ($form_state['values']['opening_type'] == 'free_text'){
    variable_set('simple_restaurant_contact_opening_hours_type', 'free_text'); 
	variable_set('simple_restaurant_contact_opening_hours_text', $form_state['values']['free_text']);
  }
  else  
  { 
    variable_set('simple_restaurant_contact_opening_hours_type', 'table'); 
    $opening_table = array(
      'sun' => array ( 'title' => t('Sunday'), 'am' => $form_state['values']['opening_sun']['am'] , 'pm' => $form_state['values']['opening_sun']['pm'] ),  
	  'mon' => array ( 'title' => t('Monday'),'am' => $form_state['values']['opening_mon']['am'] , 'pm' => $form_state['values']['opening_mon']['pm'] ), 
	  'tue' => array ( 'title' => t('Tuesday'),'am' => $form_state['values']['opening_tue']['am'] , 'pm' => $form_state['values']['opening_tue']['pm'] ), 
	  'wed' => array ( 'title' => t('Wednesday'),'am' => $form_state['values']['opening_wed']['am'] , 'pm' => $form_state['values']['opening_wed']['pm'] ), 
	  'thu' => array ( 'title' => t('Thursday'),'am' => $form_state['values']['opening_thu']['am'] , 'pm' => $form_state['values']['opening_thu']['pm'] ), 
	  'fri' => array ( 'title' => t('Friday'),'am' => $form_state['values']['opening_fri']['am'] , 'pm' => $form_state['values']['opening_fri']['pm'] ), 
	  'sat' => array ( 'title' => t('Saturday'),'am' => $form_state['values']['opening_sat']['am'] , 'pm' => $form_state['values']['opening_sat']['pm'] ), 
	  );  
    variable_set('simple_restaurant_contact_opening_hours', $opening_table); 
  }
  
  drupal_set_message(t('Information saved'));
  
}

/**
* Implements hook_elements().
*
* New types of elements form information form
*/
function simple_restaurant_contact_element_info() {
  return array(
    // Form type simple_restaurant_contact opening day
    'simple_restaurant_contact_opening_day' => array(
      '#input' => TRUE,
      '#tree' => TRUE,
      '#process' => array('simple_restaurant_contact_element_process_callback'),
      //'#element_validate' => array('simple_restaurant_contact_element_validate'),
      //'#theme' => array('simple_restaurant_contact_element'),
      //'#theme_wrappers' => array('simple_restaurant_contact_inline_form_element'),
	  '#theme_wrappers' => array('form_element'),
    ),
  );
}

/**
* Generates form type simple_restaurant_contact opening day
*/
function simple_restaurant_contact_element_process_callback($element, &$form_state) {
  
  // Add two textfields to the element
  $element['am'] = array(
    '#type' => 'textfield',
    '#title' => t('Morning'),
    '#value' => $element['#value']['am'],	
  );
  $element['pm'] = array(
    '#type' => 'textfield',
    '#title' => t('Evening'),
	'#value' => $element['#value']['pm'],
  );
  
  return $element;
}

/**
 * @} End of "defgroup simple_restaurant_contact".
 */
